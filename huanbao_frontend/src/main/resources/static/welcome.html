<meta charset="utf-8"/>
<style type="text/css">
    #container{
        height:1080px;
        width:1366px;
        margin-left:-4px;
    }
</style>
<div class="row">
    <div class="col-xs-12">
        <div class="row">
            <div class="col-xs-12" style="padding-top:5px;">
              <table class="no-border" style="display:inline;">
                <tr>
                  <td style="padding: 0px 6px;">
                    区域
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="text" id="site_label" class="form-control search-query" placeholder="选择区域查询查看" style="width:140px"/>
                      <input type="hidden" id="site_id" class="form-control"/>
                    </div>
                  </td>
                  <td class="hidden-480" style="padding: 0px 6px;">
                    位置地点
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="text" id="key_county_id" class="form-control search-query hidden-480" placeholder="选择位置地点名称" style="width:140px"/>
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-inverse btn-white" id="btnSearch">
                            <span class="ace-icon fa fa-search bigger-110"></span>
                            查询
                        </button>
                      </span>
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-inverse btn-white" id="btn6065">
                          <span class="ace-icon fa fa-battery-half bigger-110"></span>
                          超标
                        </button>
                      </span>
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-inverse btn-white" id="btn65">
                          <span class="ace-icon fa fa-battery-3 bigger-110"></span>
                          严重超标
                          </button>
                        </span>
                    </div>
                  </td>
                </tr>
              </table>
              <div style="width:176px;background:#fff;position:absolute;right:0px;z-index:80" id="sideRight">
                <table id="rightTable" class="table table-striped table-bordered table-hover">
                  <thead>
                  <tr>
                    <td>位置地点名称</td>
                    <td>噪音值</td>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td colspan="2" style="height:37px;text-align:center;">正在加载……</td>
                  </tr>
                  </tbody>
                </table>
              </div>
              <div id="container"></div>
            </div>
        </div>
    </div>
</div>
<div id="div_bind_area" style="display:none;padding:2px 2px 2px 0px">
  <div class="input-group">
    <input type="text" id="siteName" class="form-control search-query" placeholder="位置地点名称关键字查询"/>
    <span class="input-group-btn">
      <button type="button" class="btn btn-inverse btn-white" id="areaSearch">
        <span class="ace-icon fa fa-search bigger-110"></span>
        查询
      </button>
    </span>
  </div>
  <table id="listArea" class="table table-striped table-bordered table-hover">
    <thead>
    <tr>
      <td>选项</td>
      <td>位置地点名称</td>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td colspan="2" style="height:37px;text-align:center;">正在加载……</td>
    </tr>
    </tbody>
  </table>
</div>
<script type="text/javascript">
    function windowShow() {
        var width = winFn.fnGetWidth();
        var height = winFn.fnGetHeight();
        $('#container').css({"width":(width-238)+"px","height":(height-132)+"px","min-height":(height-132)+"px"});
        $('#sideRight').css({"height":(height-132)+"px","min-height":(height-132)+"px"});
    }
    var scripts = [null, null];
    $('.page-content-area').ace_ajax('loadScripts', scripts, function(){
        $(function($){
            windowShow();
        });
    });
    $(window).resize(function () {
        windowShow();
    }).resize();

    //todo 圆形中心的颜色越深说明噪音越大
    function initMap(lng,lat,data){
      var map = new BMap.Map("container");          // 创建地图实例
      var point = new BMap.Point(lng,lat);
      map.centerAndZoom(point,15);             // 初始化地图，设置中心点坐标和地图级别
      map.setCurrentCity("贵阳市");		//设置当前显示城市
      map.enableScrollWheelZoom(); // 允许滚轮缩放
      if(!isSupportCanvas()){
        alert('热力图目前只支持有canvas支持的浏览器,您所使用的浏览器不能使用热力图功能~')
      }
      heatmapOverlay = new BMapLib.HeatmapOverlay({"radius":50,"visible":true});/*半径大小,可以调整*/
      map.addOverlay(heatmapOverlay);
      heatmapOverlay.setDataSet({data:data,max:90});/*最大值,可以调整,值越小显示的颜色越多，显示的圆圈就越多，它跟 count 的值有关 */
    }

    initMap(106.703243,26.570824,[]);

    //closeHeatmap();
    //判断浏览区是否支持canvas
    function isSupportCanvas(){
        var elem = document.createElement('canvas');
        return !!(elem.getContext && elem.getContext('2d'));
    }

    function setGradient(){
        var gradient = {};
        var colors = document.querySelectorAll("input[type='color']");
        colors = [].slice.call(colors, 0);
        colors.forEach(function(ele){
            gradient[ele.getAttribute("data-key")] = ele.value;
        });
        heatmapOverlay.setOptions({"gradient": gradient});
    }

    //显示热力图
    function openHeatmap(){
        heatmapOverlay.show();
    }

    //隐藏 热力图
    function closeHeatmap(){
        heatmapOverlay.hide();
    }
    var urlGetSiteList = '/location/getSiteList';/*获取位置地点名称*/
    $(function(){
      thisPage = {
        init : function(){
          this.addEvent();
          this.initDom();
        },
        initDom : function(){
          thisPage.getListMap();
        },
        addEvent : function(){
          $('#btnSearch').on('click',function(){
            thisPage.getListMap();
          });
          $('#btn6065').on('click',function(){
            thisPage.getListMap();
          });
          $('#btn65').on('click',function(){
            thisPage.getListMap();
          });
          $('#areaSearch').on('click',function(){
            var value = winFn.getDomValue('#siteName');
            thisPage.getListSite(value);
          });
          $('#site_label').on('click',function(){
            thisPage.addBindArea();
          });
        },
        getListMap : function(){
          var params = {
            site_id : $('#site_id').val(),
          }
          this.renderMap(this.tableRow('正在查询……'));
          layerFn.ajaxGetResult('/monitorValue/getListMap',params,function(data){
            thisPage.renderTableHtml(data);
          });
        },
        addBindArea : function(){
          layerFn.winDom('选择地点位置','#div_bind_area',['550px','450px'],function(index,layero){
            var siteKid = $("input[name='siteKid']:checked").val();
            var alt = $("input[name='siteKid']:checked").attr('alt');
            if(siteKid != null && siteKid.length > 0){
              $('#site_label').val(alt);
              $('#site_id').val(siteKid);
              layerFn.closeIndex(index);
            }else{
              layerFn.alert('请选择地点位置', AppKey.code.code199);
            }
          });
          thisPage.getListSite();
        },
        getListSite : function(value){
          var params = {};
          if(value != null && value.length > 0){
            params = {
              value : value
            };
          }
          layerFn.queryGetHandleHint(urlGetSiteList,params,function(data){
            thisPage.renderArea(data);
          });
        },
        renderArea : function(data){
          var html = '';
          if(AppKey.code.code200 == data.code){
            data = data.data;
            for(var i=0;i<data.length;i++){
              var obj = data[i];
              html += '<tr>';
              html += '<td class="tableArea"><input type="radio" alt="'+obj.name+'" name="siteKid" value="'+obj.kid+'"/></td>';
              html += '<td>'+obj.name+'</td>';
              html += '</tr>';
            }
          }else if(AppKey.code.code201 == data.code){
            html = '<td colspan="2" style="height:37px;text-align:center;">没有查到数据,请换个关键字试试</td>';
          }else{
            html = '<td colspan="2" style="height:37px;text-align:center;">'+data.msg+'</td>';
          }
          $('#listArea tbody').empty().html(html);
        },
        renderTableHtml : function(data){
          var html = '';
          if(AppKey.code.code200 == data.code){
            data = data.data;
            initMap(106.703243,26.570824,data);
            for(var i=0;i<data.length;i++){
              var obj = data[i];
              html += '<tr>';
              html += '<td onclick="thisPage.infoTips(\''+obj.siteName+'\',\''+obj.count+'\')" title="'+obj.siteName+'"><div style="white-space:nowrap;overflow:hidden;text-overflow: ellipsis;width:100px;">'+obj.siteName+'</div></td>';
              html += '<td>'+obj.count+'</td>';
              html += '</tr>';
            }
          }else if(AppKey.code.code201 == data.code){
            html += this.tableRow('没有查到数据');
          }else{
            html += this.tableRow(data.msg);
          }
          this.renderMap(html);
        },
        tableRow : function(msg){
          return '<td colspan="2" style="height:37px;text-align:center;">'+msg+'</td>';
        },
        renderMap : function(html){
          $('#rightTable tbody').empty().html(html);
        },
        infoTips : function(siteName,value){
          var html = "名称:"+siteName+"<br/>噪音值:"+value;
          layerFn.alert(html);
        }
      };
      thisPage.init();
    });
</script>