<meta charset="utf-8"/>
<style type="text/css">
    #container{
        height:1080px;
        width:1366px;
        margin-left:-4px;
    }
</style>
<div class="row">
    <div class="col-xs-12">
        <div class="row">
            <div class="col-xs-12">
              <table class="no-border" style="display:inline;margin-top:10px;">
                <tr>
                  <td style="padding: 0px 6px;">
                    区域
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="text" id="key_name" class="form-control search-query" placeholder="选择区域查询查看" style="width:140px"/>
                    </div>
                  </td>
                  <td class="hidden-480" style="padding: 0px 6px;">
                    位置地点
                  </td>
                  <td>
                    <div class="input-group">
                      <input type="text" id="key_county_id" class="form-control search-query hidden-480" placeholder="选择位置地点名称" style="width:140px"/>
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-inverse btn-white" id="btnSearch">
                            <span class="ace-icon fa fa-search bigger-110"></span>
                            查询
                        </button>
                      </span>
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-inverse btn-white" id="btn6065">
                          <span class="ace-icon fa fa-battery-half bigger-110"></span>
                          超标
                        </button>
                      </span>
                    </div>
                  </td>
                  <td>
                    <div class="input-group">
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-inverse btn-white" id="btn65">
                          <span class="ace-icon fa fa-battery-3 bigger-110"></span>
                          严重超标
                          </button>
                        </span>
                    </div>
                  </td>
                </tr>
              </table>
              <div style="width:176px;background:#fff;position:absolute;right:0px;height:800px;z-index:80" id="sideRight">
                <table id="listArea" class="table table-striped table-bordered table-hover">
                  <thead>
                  <tr>
                    <td>位置地点名称</td>
                    <td>噪音值</td>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td colspan="2" style="height:37px;text-align:center;">正在加载……</td>
                  </tr>
                  </tbody>
                </table>
              </div>
              <div id="container"></div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    function windowShow() {
        var width = winFn.fnGetWidth();
        var height = winFn.fnGetHeight();
        $('#container').css({"width":(width-238)+"px","height":(height-134)+"px","min-height":(height-134)+"px"});
        $('#sideRight').css({"height":(height-134)+"px","min-height":(height-134)+"px"});
    }
    var scripts = [null, null];
    $('.page-content-area').ace_ajax('loadScripts', scripts, function(){
        $(function($){
            windowShow();
        });
    });
    $(window).resize(function () {
        windowShow();
    }).resize();
    var map = new BMap.Map("container");          // 创建地图实例
    var point = new BMap.Point(106.703243,26.570824);
    map.centerAndZoom(point,15);             // 初始化地图，设置中心点坐标和地图级别
    map.setCurrentCity("贵阳市");		//设置当前显示城市
    map.enableScrollWheelZoom(); // 允许滚轮缩放
    var points = [//todo 圆形中心的颜色越深说明噪音越大
      {"lng": "106.717184", "lat": "26.571257", "count": "80"},/*尚义小学*/
      //{"lng": "106.688367", "lat": "26.568522", "count": "60"},
      //{"lng": "106.690959", "lat": "26.567427", "count": "60"},
      //{"lng": "106.690371", "lat": "26.566345", "count": "60"},
      {"lng": "106.68768", "lat": "26.567528", "count": "60"}/*兰花广场*/
    ];//这里面添加经纬度

    if(!isSupportCanvas()){
        alert('热力图目前只支持有canvas支持的浏览器,您所使用的浏览器不能使用热力图功能~')
    }

    //详细的参数,可以查看heatmap.js的文档 https://github.com/pa7/heatmap.js/blob/master/README.md
    //参数说明如下:
    /* visible 热力图是否显示,默认为true
     * opacity 热力的透明度,1-100
     * radius 势力图的每个点的半径大小
     * gradient  {JSON} 热力图的渐变区间 . gradient如下所示
     *
    {
            .2:'rgb(0, 255, 255)',
            .5:'rgb(0, 110, 255)',
            .8:'rgb(100, 0, 255)'
        }
    其中 key 表示插值的位置, 0~1.
            value 为颜色值.
     */
    heatmapOverlay = new BMapLib.HeatmapOverlay({"radius":50,"visible":true});/*半径大小,可以调整*/
    map.addOverlay(heatmapOverlay);
    heatmapOverlay.setDataSet({data:points,max:90});/*最大值,可以调整,值越小显示的颜色越多，显示的圆圈就越多，它跟 count 的值有关 */
    //closeHeatmap();
    //判断浏览区是否支持canvas
    function isSupportCanvas(){
        var elem = document.createElement('canvas');
        return !!(elem.getContext && elem.getContext('2d'));
    }

    function setGradient(){
        /*格式如下所示:
            {
                0:'rgb(102, 255, 0)',
                .5:'rgb(255, 170, 0)',
                1:'rgb(255, 0, 0)'
       }*/
        var gradient = {};
        var colors = document.querySelectorAll("input[type='color']");
        colors = [].slice.call(colors, 0);
        colors.forEach(function(ele){
            gradient[ele.getAttribute("data-key")] = ele.value;
        });
        heatmapOverlay.setOptions({"gradient": gradient});
    }

    //显示热力图
    function openHeatmap(){
        heatmapOverlay.show();
    }

    //隐藏 热力图
    function closeHeatmap(){
        heatmapOverlay.hide();
    }

    $(function(){
      thisPage = {
        init : function(){
          this.addEvent();
          this.initDom();
        },
        initDom : function(){
          thisPage.getListMap({});
        },
        addEvent : function(){
          $('#btnSearch').on('click',function(){
            var params = {};
            thisPage.getListMap(params);
          });
          $('#btn6065').on('click',function(){
            var params = {};
            thisPage.getListMap(params);
          });
          $('#btn65').on('click',function(){
            var params = {};
            thisPage.getListMap(params);
          });
        },
        getListMap : function(params){
          this.renderMap(this.tableRow('正在查询……'));
          layerFn.ajaxGetResult('/monitorValue/getListMap',params,function(data){
            thisPage.renderTableHtml(data);
          });
        },
        renderTableHtml : function(data){
          var html = '';
          if(AppKey.code.code200 == data.code){
            data = data.data;
            for(var i=0;i<data.length;i++){
              var obj = data[i];
              html += '<tr>';
              html += '<td onclick="thisPage.infoTips(\''+obj.siteName+'\',\''+obj.count+'\')" title="'+obj.siteName+'"><div style="white-space:nowrap;overflow:hidden;text-overflow: ellipsis;width:100px;">'+obj.siteName+'</div></td>';
              html += '<td>'+obj.count+'</td>';
              html += '</tr>';
            }
          }else if(AppKey.code.code201 == data.code){
            html += this.tableRow('没有查到数据');
          }else{
            html += this.tableRow(data.msg);
          }
          this.renderMap(html);
        },
        tableRow : function(msg){
          return '<td colspan="2" style="height:37px;text-align:center;">'+msg+'</td>';
        },
        renderMap : function(html){
          $('#listArea tbody').empty().html(html);
        },
        infoTips : function(siteName,value){
          var html = "名称:"+siteName+"<br/>噪音值:"+value;
          layerFn.alert(html);
        }
      };
      thisPage.init();
    });
</script>