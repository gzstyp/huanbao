<meta charset="utf-8"/>
<style type="text/css">
    .tableArea{
        width:40px;
        text-align:center;
    }
</style>
<link rel="stylesheet" href="location/layui/css/layui.css" media="all"/>
<div class="row">
    <div class="col-xs-12">
        <div class="row">
            <div class="col-xs-12">
                <div class="clearfix">
                    <table class="no-border" style="display:inline">
                        <tr permission='location_btn_listData' style="display:none">
                            <td style="padding: 0px 6px;">
                                检测点名称
                            </td>
                            <td>
                                <div class="input-group">
                                    <input type="text" id="key_name" class="form-control search-query" placeholder="检测点名称" style="width:140px"/>
                                </div>
                            </td>
                            <td style="padding: 0px 6px;">
                                位置地点
                            </td>
                            <td>
                                <div class="input-group">
                                    <input type="text" id="key_siteName" class="form-control search-query" placeholder="位置地点名称" style="width:140px"/>
                                </div>
                            </td>
                            <td class="hidden-480" style="padding: 0px 6px;">
                                区域
                            </td>
                            <td>
                                <div class="input-group">
                                    <input type="text" id="key_county_id" class="form-control search-query hidden-480" placeholder="选择区域" style="width:140px"/>
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-inverse btn-white" id="btnSearch" permission='location_btn_listData' style="display:none">
                                            <span class="ace-icon fa fa-search bigger-110"></span>
                                            搜索
                                        </button>
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-inverse btn-white" id="btnAdd" permission='location_btn_add' style="display:none">
                                            <span class="ace-icon glyphicon glyphicon-plus bigger-110"></span>
                                            添加
                                        </button>
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-inverse btn-white" id="btnDel" permission='location_btn_delByKeys' style="display:none">
                                            <span class="fa fa-trash red2 bigger-110"></span>
                                            删除
                                        </button>
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <div class="hidden-480 pull-right tableTools-container" permission='location_btn_listData' style="display:none"></div>
                </div>
                <table id="tableListLocation" class="table table-striped table-bordered table-hover"></table>
            </div>
        </div>
    </div>
</div>
<div id="div_location_edit" style="display:none;padding:2px 0px;">
    <form class="form-horizontal" id="form_location_edit" role="form">
        <label class="col-sm-3 control-label no-padding-right" for="name"><div class="hr-4"></div>检测点名称</label>
        <div class="col-sm-7">
            <div class="hr-4"></div>
            <input type="text" id="name" placeholder="检测点名称" class="form-control"/>
        </div>
        <label class="col-sm-3 control-label no-padding-right" for="site_id"><div class="hr-4"></div>设备标识名称</label>
        <div class="col-sm-7">
            <div class="hr-4"></div>
            <input type="text" id="flag_name" placeholder="选择已添加设备标识名称" class="form-control"/>
            <input type="hidden" id="device_id" class="form-control"/>
        </div>
        <label class="col-sm-3 control-label no-padding-right" for="site_id"><div class="hr-4"></div>位置地点</label>
        <div class="col-sm-7">
            <div class="hr-4"></div>
            <input type="text" id="site_label" placeholder="点击选择位置地点" class="form-control"/>
            <input type="hidden" id="site_id" class="form-control"/>
        </div>
        <label class="col-sm-3 control-label no-padding-right" for="longs"><div class="hr-4"></div>经度</label>
        <div class="col-sm-7">
            <div class="hr-4"></div>
            <div class="input-group">
                <input type="text" id="longs" class="form-control search-query hidden-480" maxlength="20" placeholder="经度" oninput="value=value.replace(/[^\d.]/g,'')"/>
                <span class="input-group-btn">
                    <button type="button" class="btn btn-inverse btn-white" id="btnLongs">
                        <span class="ace-icon fa fa-asl-interpreting bigger-110"></span>
                        经度
                    </button>
                </span>
            </div>
        </div>
        <label class="col-sm-3 control-label no-padding-right" for="longs"><div class="hr-4"></div>纬度</label>
        <div class="col-sm-7">
            <div class="hr-4"></div>
            <div class="input-group">
                <input type="text" id="lat" class="form-control search-query hidden-480" maxlength="20" placeholder="纬度" oninput="value=value.replace(/[^\d.]/g,'')"/>
                <span class="input-group-btn">
                    <button type="button" class="btn btn-inverse btn-white" id="btnLat">
                        <span class="ace-icon fa fa-asl-interpreting bigger-110"></span>
                        纬度
                    </button>
                </span>
            </div>
        </div>
        <label class="col-sm-3 control-label no-padding-right" for="county_name"><div class="hr-4"></div>监测区域</label>
        <div class="col-sm-7">
            <div class="hr-4"></div>
            <input type="text" id="county_name" placeholder="选择监测区域" class="form-control"/>
            <input type="hidden" id="county_id"/>
            <input type="hidden" id="province_id"/>
            <input type="hidden" id="province_name"/>
            <input type="hidden" id="city_id"/>
            <input type="hidden" id="city_name"/>
        </div>
        <label class="col-sm-3 control-label no-padding-right" for="address"><div class="hr-4"></div>区域地址</label>
        <div class="col-sm-7">
            <div class="hr-4"></div>
            <input type="text" id="address" placeholder="区域详细地址" class="form-control"/>
        </div>
        <label class="col-sm-3 control-label no-padding-right" for="area"><div class="hr-4"></div>监测面积(亩)</label>
        <div class="col-sm-7">
            <div class="hr-4"></div>
            <input type="text" id="area" placeholder="监测面积（亩）" class="form-control" oninput="value=value.replace(/[^\d.]/g,'')"/>
        </div>
        <label class="col-sm-3 control-label no-padding-right" for="description"><div class="hr-4"></div>描述备注</label>
        <div class="col-sm-7">
            <div class="hr-4"></div>
            <input type="text" id="description" placeholder="描述" class="form-control" maxlength="512"/>
        </div>
    </form>
</div>
<div id="divKeyColumns" style="display:none;padding:1px 0px;"></div>
<input type="hidden" id="location_edit_keyId"/>
<div style="display:none;">
    <input type="hidden" id="location_btn_listData"/>
    <input type="hidden" id="location_btn_add"/>
    <input type="hidden" id="location_row_edit"/>
    <input type="hidden" id="location_row_queryById"/>
    <input type="hidden" id="location_row_delById"/>
    <input type="hidden" id="location_btn_delByKeys"/>
    <input type="hidden" id="location_btn_getListSite"/>
    <input type="hidden" id="location_btn_getAreaTree"/>
</div>
<div id="div_bind_area" style="display:none;padding:2px 2px 2px 0px">
    <div class="input-group">
        <input type="text" id="siteName" class="form-control search-query" placeholder="位置地点名称关键字查询"/>
        <span class="input-group-btn">
            <button type="button" class="btn btn-inverse btn-white" id="areaSearch">
                <span class="ace-icon fa fa-search bigger-110"></span>
                查询
            </button>
        </span>
    </div>
    <table id="listArea" class="table table-striped table-bordered table-hover">
        <thead>
        <tr>
            <td>选项</td>
            <td>位置地点名称</td>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td colspan="2" style="height:37px;text-align:center;">正在加载……</td>
        </tr>
        </tbody>
    </table>
</div>
<div id="div_device_name" style="display:none;padding:2px 2px 2px 0px">
    <div class="input-group">
        <input type="text" id="deviceFlagName" class="form-control search-query" placeholder="设备名称标识关键字"/>
        <span class="input-group-btn">
            <button type="button" class="btn btn-inverse btn-white" id="deviceSearch">
                <span class="ace-icon fa fa-search bigger-110"></span>
                查询
            </button>
        </span>
    </div>
    <table id="listDevice" class="table table-striped table-bordered table-hover">
        <thead>
        <tr>
            <td>选项</td>
            <td>设备名称标识</td>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td colspan="2" style="height:37px;text-align:center;">正在加载……</td>
        </tr>
        </tbody>
    </table>
</div>
<!-- 绑定区域 -->
<div id="proxyAreaLayer" style="display: none;padding:6px;">
    <ul id="proxyAreaTree" class="ztree">
        <li style="margin-top:2px;"><span>获取数据失败</span></li>
    </ul>
</div>
<script type="text/javascript">
    var ztreeReqFlag = true;
    var domTree = 'proxyAreaTree';
    var tree_obj = null;
    var settingArea = {
        view : {
            expandSpeed : 100,
            showLine : true,
            showIcon : true,
            fontCss : {"color":"#000","outline":"none","text-decoration":"none","font-size":"14px"}
        },
        check : {
            enable : true,
            chkStyle : "checkbox",
            chkboxType : {"Y":"p","N":"ps"}
        },
        data : {
            simpleData : {
                enable : true,
                idKey : "kid",
                pIdKey : "pid"
            }
        },
        async : {
            enable : true,
            url : urlPrefix + '/location/getAreaTree',
            cache : false,
            type: "GET",
            autoParam : ["kid"],
            otherParam: ["accessToken",sessionStorage.getItem('accessToken'),"refreshToken",sessionStorage.getItem("refreshToken"),"token",function(){return $("#type").val()}],
            dataFilter: function(treeId,parentNode,result){
                layerFn.closeIndex(self.layerIndex);
                var bl = layerFn.checkLogin(result);
                if(bl){
                    thisPage.ztreeGetError('未登录或登录超时');
                    return;
                }
                if(result.code == AppKey.code.code200)return result.data;
                if(result){
                    if(result.code != AppKey.code.code201){
                        layerFn.alert(result.msg,result.code);
                    }
                }
                return '';
            }
        },
        callback : {
            beforeAsync : function(treeId,treeNode){
                if(treeNode){
                    if(verifyFn.inputCheck('#location_btn_getAreaTree','没有操作权限'))return false;
                }
                if(ztreeReqFlag){
                    ztreeReqFlag = false;
                    self.layerIndex = layerFn.loading('正在处理……');
                }
            },
            onAsyncSuccess : function(data){
                layerFn.closeIndex(self.layerIndex);
            },
            onAsyncError : function(){
                layerFn.alert(AppKey.msg_error);
                thisPage.ztreeGetError('连接服务器失败');
            },
            beforeClick : function(treeId,node,clickFlag){
                return false;//true时点击选中文本
            },
            onClick : function(event,treeIdDom,node,clickFlag){},
            beforeCheck : function(treeId,treeNode){},
            onCheck : function(event,treeId,treeNode){}
        }
    };

    var scripts = [null,null];
    $('.page-content-area').ace_ajax('loadScripts',scripts,function(){
        var tableDom = '#tableListLocation';
        var inputEditKeyId = '#location_edit_keyId';
        $(function(){
            var urlRoute = '/location/';/*请求controller层的url*/
            var getList = urlRoute + 'listData';/*获取数据列表*/
            var urlAdd = urlRoute + 'add';/*添加*/
            var urlEdit = urlRoute + 'edit';/*编辑*/
            var urlQueryById = urlRoute + 'queryById';/*根据id查询对应的数据*/
            var urlDelById = urlRoute + 'delById';/*根据id删除对应的数据*/
            var urlDelByKeys = urlRoute + 'delByKeys';/*批量删除*/
            var urlGetSiteList = urlRoute + 'getSiteList';/*获取位置地点名称*/
            var urlGetDeviceList = urlRoute + 'getDeviceList';/*获取设备标识名称*/
            var thisTable = pageDataTable.initDataTable({
                tableDom : tableDom,
                sAjaxSource: getList,
                fnServerParams : function(params){
                    params.push({"name":"name","value":$("#key_name").val()},{"name":"siteName","value":$("#key_siteName").val()},{"name":"county_id","value":$("#key_county_id").val()});
                },
                aoColumns : [
                    {
                        bSortable: false,
                        mData : "kid",
                        sWidth : "38px",
                        sClass : "center",
                        sTitle : '<label title="全选|不选"><input type="checkbox" class="ace" /><span class="lbl"></span></label>'
                    },
                    {
                        mData : "name",
                        sTitle : "检测点名称"
                    },
                    {
                        mData : "siteName",
                        sTitle : "位置地点",
                        sWidth : "10%"
                    },
                    {
                      mData : "longs",
                      sTitle : "经纬度",
                      sWidth : "10%",
                      render : function(value,type,row,meta){
                        return row.longs+','+row.lat;
                      }
                    },
                    {
                        mData : "flag_name",
                        sTitle : "设备标识名称"
                    },
                    {
                        mData : "county_name",
                        sTitle : "区域名称"
                    },
                    {
                        mData : "address",
                        sTitle : "区域地址",
                        sWidth : "8%"
                    },
                    {
                        mData : "area",
                        sTitle : "面积（亩）",
                        sWidth : "7%"
                    },
                    {
                        mData : "description",
                        sTitle : "备注描述"
                    },
                    {
                        mData : "_kid_",
                        sTitle : "<label style='color:#000;margin-left:6px;' title='单行操作'>操作选项</label>",
                        bSortable : false,
                        sWidth : "8%"
                    }
                ],
                columnDefs : [
                    {
                        targets : 0,//指定的列
                        render : function(value,type,row,meta){
                            return '<label title="选择|取消"><input type="checkbox" name="kid" value="'+value+'" style="cursor:pointer;text-decoration:none;outline:none;"/><span class="lbl"></span></label>';
                        }
                    },
                    {
                        targets : -1,
                        render : function(value,type,row,meta){
                            var html = "<a href='javascript:thisPage.rowEdit("+meta.row+");' style='outline:none;text-decoration: none;color:#3b8cff;margin-left:6px;display:none' permission='location_row_edit'>编辑</a>"+
                                "<a class='hidden-xs' href='javascript:thisPage.rowDel("+meta.row+");' style='outline:none;text-decoration: none;color:#f00;margin-left:6px;display:none' permission='location_row_delById'>删除</a>";
                            return html;
                        }
                    },
                    {
                        targets: [1,2,3,4,5,6,7,8],
                        render: function (value,type,row,meta){
                            return pageDataTable.formatColumn(value);
                        }
                    },
                    {
                        "visible":false,//列的隐藏显示
                        "targets": []//指定列
                    }
                ]
            });
            pageDataTable.buttons(thisTable);
            pageDataTable.action(thisTable);
            pageDataTable.select(thisTable,tableDom);
            pageDataTable.tooltip();
            var thisJquery = $(tableDom).dataTable();
            thisPage = {
                init : function(){
                    this.addEvent();
                },
                initDom : function(){
                },
                createDropdown : function(){
                },
                initTree : function(){
                    tree_obj = $.fn.zTree.init($("#"+domTree),settingArea);
                },
                addEvent : function(){
                    this.btnEvent();
                },
                btnEvent : function(){
                    $(tableDom +' tbody').on('dblclick','tr',function(){
                        if(verifyFn.inputRequired('#location_row_edit')){
                            return;
                        }
                        thisPage.trDblclick(thisTable.row(this).data());
                    });
                    $('#btnAdd').on('click',function(){
                        thisPage.edit();
                    });
                    //搜索按钮
                    $('#btnSearch').on('click',function(){
                        thisPage.search();
                    });
                    //按钮组-自定义显示列
                    $('#iconColumn').parent().parent().on('click',function(){
                        pageDataTable.columnCustom(thisTable,tableDom,'#divKeyColumns');
                    });
                    //按钮组-搜索
                    $('#iconRefresh').parent().parent().on('click',function(){
                        thisPage.search();
                    });
                    $('#btnDel').on('click',function(){
                        thisPage.delKeys();
                    });
                    $('#areaSearch').on('click',function(){
                        var value = winFn.getDomValue('#siteName');
                        thisPage.getListSite(value);
                    });
                    $('#deviceSearch').on('click',function(){
                        var value = winFn.getDomValue('#deviceFlagName');
                        thisPage.getListDevice(value);
                    });
                    $('#site_label').on('click',function(){
                        thisPage.addBindArea();
                    });
                    $('#county_name').on('click',function(){
                        thisPage.showAreaTree();
                    });
                    $('#btnLongs').on('click',function(){
                        thisPage.openPage();
                    });
                    $('#btnLat').on('click',function(){
                        thisPage.openPage();
                    });
                    $('#flag_name').on('click',function(){
                        thisPage.addDeviceName();
                    });
                },
                openPage : function(){
                  //window.open('/location/index.html','_blank').location;
                  window.open('http://api.map.baidu.com/lbsapi/getpoint/index.html','_blank').location;
                },
                showAreaTree : function(){
                    ztreeReqFlag = true;
                    layerFn.addOrEdit('选择区域位置','#proxyAreaLayer',['500px','500px'],function(indexLayero,layero){
                        var nodes = tree_obj.getCheckedNodes(true);
                        var length = nodes.length;
                        if(length == 0){
                          layerFn.alert('选择区域位置有误', AppKey.code.code199);
                          return;
                        }
                        if(length != 3){
                            var indexLevel0Total = 0;
                            var indexLevel1Total = 0;
                            var indexLevel2Total = 0;
                            for(var i=0;i<nodes.length;i++){
                                var level = nodes[i].level;
                                if(level == 0){
                                    indexLevel0Total++;
                                }
                                if(level == 1){
                                    indexLevel1Total++;
                                }
                                if(level == 2){
                                    indexLevel2Total++;
                                }
                            }
                            if(indexLevel0Total > 1){
                                layerFn.alert('仅能选一个省级', AppKey.code.code199);
                                return;
                            }
                            if(indexLevel1Total > 1){
                                layerFn.alert('仅能选一个市级', AppKey.code.code199);
                                return;
                            }
                            if(indexLevel2Total > 1){
                                layerFn.alert('仅能选一个区', AppKey.code.code199);
                                return;
                            }
                            layerFn.alert('选择区域位置有误', AppKey.code.code199);
                        }else{
                            var indexLevel0Total = 0;
                            var indexLevel1Total = 0;
                            var indexLevel2Total = 0;
                            for(var i=0;i<nodes.length;i++){
                                var level = nodes[i].level;
                                if(level == 0){
                                    indexLevel0Total++;
                                }
                                if(level == 1){
                                    indexLevel1Total++;
                                }
                                if(level == 2){
                                    indexLevel2Total++;
                                }
                            }
                            if(indexLevel0Total > 1){
                                layerFn.alert('仅能选一个省级', AppKey.code.code199);
                                return;
                            }
                            if(indexLevel1Total > 1){
                                layerFn.alert('仅能选一个市级', AppKey.code.code199);
                                return;
                            }
                            if(indexLevel2Total > 1){
                                layerFn.alert('仅能选一个区', AppKey.code.code199);
                                return;
                            }
                            var json = null;
                            for(var i=0;i<nodes.length;i++){
                                var obj = nodes[i];
                                var level = obj.level;
                                if(level == 2){
                                    json = obj;
                                    break;
                                }
                            }
                            if(json == null){
                                layerFn.alert('选择区域位置有误', AppKey.code.code199);
                                return;
                            }
                            layer.close(indexLayero);
                            if(nodes){
                                var address = '';
                                for(var i=0;i<nodes.length;i++){
                                    var obj = nodes[i];
                                    var level = obj.level;
                                    if(level == 0){
                                        $('#province_id').val(obj.kid);
                                        $('#province_name').val(obj.name);
                                        continue;
                                    }
                                    if(level == 1){
                                        $('#city_id').val(obj.kid);
                                        $('#city_name').val(obj.name);
                                        address += obj.name;
                                        continue;
                                    }
                                    if(level == 2){
                                        $('#county_id').val(obj.kid);
                                        $('#county_name').val(obj.name);
                                        address += obj.name;
                                        continue;
                                    }
                                }
                                $('#address').val(address);
                            }
                        }
                    });
                    thisPage.initTree();//再次调用便是刷新树
                },
                getListSite : function(value){
                    var params = {};
                    if(value != null && value.length > 0){
                        params = {
                            value : value
                        };
                    }
                    layerFn.queryGetHandleHint(urlGetSiteList,params,function(data){
                        thisPage.renderArea(data);
                    });
                },
                getListDevice : function(value){
                    var params = {};
                    if(value != null && value.length > 0){
                        params = {
                            value : value
                        };
                    }
                    layerFn.queryGetHandleHint(urlGetDeviceList,params,function(data){
                        thisPage.renderDevice(data);
                    });
                },
                addBindArea : function(){
                    if(verifyFn.inputCheck('#location_btn_getListSite','没有操作权限'))return;
                    layerFn.winDom('选择地点位置','#div_bind_area',['550px','450px'],function(index,layero){
                        var siteKid = $("input[name='siteKid']:checked").val();
                        var alt = $("input[name='siteKid']:checked").attr('alt');
                        if(siteKid != null && siteKid.length > 0){
                            $('#site_label').val(alt);
                            $('#site_id').val(siteKid);
                            layerFn.closeIndex(index);
                        }else{
                            layerFn.alert('请选择地点位置', AppKey.code.code199);
                        }
                    });
                    thisPage.getListSite();
                },
                addDeviceName : function(){
                    if(verifyFn.inputCheck('#location_btn_getListSite','没有操作权限'))return;
                    layerFn.winDom('选择设备标识名称','#div_device_name',['550px','450px'],function(index,layero){
                        var deviceKid = $("input[name='deviceKid']:checked").val();
                        var alt = $("input[name='deviceKid']:checked").attr('alt');
                        if(deviceKid != null && deviceKid.length > 0){
                            $('#flag_name').val(alt);
                            $('#device_id').val(deviceKid);
                            layerFn.closeIndex(index);
                        }else{
                            layerFn.alert('请选择设备标识名称', AppKey.code.code199);
                        }
                    });
                    thisPage.getListDevice();
                },
                ztreeGetError : function(msg){
                    msg = (msg == null || msg == '') ? '获取数据失败' : msg;
                    $('#treeDom').html("<li style='margin-top:2px;'><span>"+msg+"</span></li>");
                },
                renderArea : function(data){
                    var html = '';
                    if(AppKey.code.code200 == data.code){
                        data = data.data;
                        for(var i=0;i<data.length;i++){
                            var obj = data[i];
                            html += '<tr>';
                            html += '<td class="tableArea"><input type="radio" alt="'+obj.name+'" name="siteKid" value="'+obj.kid+'"/></td>';
                            html += '<td>'+obj.name+'</td>';
                            html += '</tr>';
                        }
                    }else if(AppKey.code.code201 == data.code){
                        html = '<td colspan="2" style="height:37px;text-align:center;">没有查到数据,请换个关键字试试</td>';
                    }else{
                        html = '<td colspan="2" style="height:37px;text-align:center;">'+data.msg+'</td>';
                    }
                    $('#listArea tbody').empty().html(html);
                },
                renderDevice : function(data){
                    var html = '';
                    if(AppKey.code.code200 == data.code){
                        data = data.data;
                        for(var i=0;i<data.length;i++){
                            var obj = data[i];
                            html += '<tr>';
                            html += '<td class="tableArea"><input type="radio" alt="'+obj.flag_name+'" name="deviceKid" value="'+obj.kid+'"/></td>';
                            html += '<td>'+obj.flag_name+'</td>';
                            html += '</tr>';
                        }
                    }else if(AppKey.code.code201 == data.code){
                        html = '<td colspan="2" style="height:37px;text-align:center;">没有查到数据,请换个关键字试试</td>';
                    }else{
                        html = '<td colspan="2" style="height:37px;text-align:center;">'+data.msg+'</td>';
                    }
                    $('#listDevice tbody').empty().html(html);
                },
                /*批量删除*/
                delKeys : function(){
                    if(verifyFn.inputCheck('#location_btn_delByKeys','没有删除操作权限'))return;
                    var kids = '';
                    var index = 0;
                    $(tableDom + ' tbody input:checked').each(function(){
                        index ++;
                        var value = this.value;
                        if(value != null && value != ''){
                            if(kids.length > 0)
                                kids += ",";
                            kids += value;
                        }
                    });
                    if(kids == ''){
                        layerFn.alert('请选择要删除的数据!',AppKey.code.code199);
                        return;
                    }
                    layerFn.confirm('将要删除['+index+']条数据且是无法恢复,确定要继续吗?',function(){
                        layerFn.delBatchHint(urlDelByKeys,kids,function(data){
                            thisPage.complete(data,null,true);
                        });
                    });
                },
                trDblclick : function(data){
                    thisPage.edit(data.kid);
                },
                search : function(){
                    if(verifyFn.inputCheck('#location_btn_listData','没有操作权限'))return;
                    $(tableDom + ' input[type=checkbox]').prop('checked',false);
                    thisTable.draw();
                },
                resetForm : function(){
                    winFn.clearFormData('#form_location_edit');
                },
                edit : function(kid){
                    var title = '添加';
                    if(kid != null && kid.length >0){
                        if(verifyFn.inputCheck('#location_row_queryById','没有操作权限'))return;
                        title = '编辑';
                        winFn.setDomValue(inputEditKeyId,kid);
                        layerFn.queryByIdHint(urlQueryById,kid,function(data){
                            thisPage.openDialog(title,kid,data);
                        });
                    }else{
                        winFn.setDomValue(inputEditKeyId,'');
                        thisPage.openDialog(title);
                    }
                },
                openDialog : function(title,kid,map){
                    var url = urlAdd;
                    if(kid != null && kid.length >0){
                        url = urlEdit;
                        if(verifyFn.inputCheck('#location_row_edit','没有编辑权限'))return;
                    }else{
                        if(verifyFn.inputCheck('#location_btn_add','没有添加权限'))return;
                    }
                    layerFn.addOrEdit(title,'#div_location_edit',['500px','430px'],function(index,layero){
                        var editKey = winFn.getDomValue(inputEditKeyId);
                        if(verifyFn.inputCheck('#name','检测点名称不能为空'))return;
                        if(editKey == null){
                            if(verifyFn.inputCheck('#site_id','请选择位置地点'))return;
                            if(verifyFn.inputCheck('#device_id','请选择设备标识名称'))return;
                        }
                        if(verifyFn.inputCheck('#longs','经度不能为空'))return;
                        if(verifyFn.inputCheck('#lat','纬度不能为空'))return;
                        if(verifyFn.inputCheck('#county_name','选择监测区域'))return;
                        if(verifyFn.inputCheck('#province_id','选择省级区域'))return;
                        if(verifyFn.inputCheck('#city_id','选择市级区域'))return;
                        var params = {
                            name : winFn.getDomValue('#name'),
                            device_id : winFn.getDomValue('#device_id'),
                            site_id : winFn.getDomValue('#site_id'),
                            longs : winFn.getDomValue('#longs'),
                            lat : winFn.getDomValue('#lat'),
                            province_id : winFn.getDomValue('#province_id'),
                            province_name : winFn.getDomValue('#province_name'),
                            city_id : winFn.getDomValue('#city_id'),
                            city_name : winFn.getDomValue('#city_name'),
                            county_id : winFn.getDomValue('#county_id'),
                            county_name : winFn.getDomValue('#county_name'),
                            address : winFn.getDomValue('#address'),
                            area : winFn.getDomValue('#area'),
                            description : winFn.getDomValue('#description'),
                            kid : winFn.getDomValue(inputEditKeyId)
                        };
                        layerFn.submit(url,params,function(data){
                            thisPage.complete(data,index,true);
                        });
                    });
                    thisPage.resetForm();//清空
                    if(map != null){
                        $.each(map.data,function(k,v){
                            try{
                                $('#'+k).val(v);
                            }catch(e){}
                        });
                    }
                },
                rowEdit : function(index){
                    var row = thisJquery.fnGetData(index);
                    thisPage.edit(row.kid);
                },
                rowDel : function(index){
                    var row = thisJquery.fnGetData(index);
                    if(verifyFn.inputCheck('#location_row_delById','没有删除操作权限'))return;
                    layerFn.confirm('删除后无法恢复,确定要删除吗?',function(){
                        layerFn.delByIdHint(urlDelById,row.kid,function(data){
                            thisPage.complete(data,null,true);
                        });
                    });
                },
                complete : function(data,index,search){
                    try{
                        if(index){
                            layerFn.closeIndex(index);
                        }
                        if(search){
                            thisPage.search();
                        }
                        if(data){
                            layerFn.handleResult(data.msg,data.code);
                        }
                    }catch(e){}
                }
            };
            thisPage.init();
        });
    });
</script>